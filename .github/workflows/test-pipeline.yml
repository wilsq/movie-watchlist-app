name: Elokuva-projekti TS-Tarkistus

# 1. MILLOIN AJETAAN?
on:
  push:
    branches: ["typescript-migration"]
  pull_request:
    branches: ["typescript-migration"]

# 2. MITÄ TEHDÄÄN?
jobs:
  tarkistus:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_DB: testdb
          POSTGRES_PASSWORD: testpassword
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      # Haetaan koodi GitHubista virtuaalikoneelle
      - name: Checkout koodi
        uses: actions/checkout@v4

      # Asennetaan Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Tehdään testi taulut tietokantaan
      - name: Initialize Database Scheman
        run: |
          # Ajetaan ensin skeema
          PGPASSWORD=testpassword psql -h localhost -U testuser -d testdb -f backend/db/schema.sql
          # Lisätään testikäyttäjä, jonka ID on 1
          PGPASSWORD=testpassword psql -h localhost -U testuser -d testdb -c "INSERT INTO users (id, email, password_hash) VALUES (1, 'test@test.com', 'hashed_pass') ON CONFLICT DO NOTHING;"

      # FRONTEND: Asennus ja Build
      - name: Build Frontend
        run: |
          cd frontend
          npm install
          npm run build

      # BACKEND: Asennus ja Build
      - name: Build Backend
        run: |
          cd backend
          npm install
          npm run build
          npm test
        env:
          NODE_ENV: "test"
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: testuser
          DB_PASSWORD: testpassword
          DB_NAME: testdb
          PGSSLMODE: disable
          JWT_SECRET: testaus-salaisuus
